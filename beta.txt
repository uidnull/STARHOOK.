-- З CONFIGURACIN PERSISTENTE ENTRE EJECUCIONES
local SETTINGS_FILE = "FreeUGS_Settings.json"
local HttpService = game:GetService("HttpService")

-- Cargar configuraci贸n desde archivo o crear una nueva
local function loadSettings()
    if isfile and isfile(SETTINGS_FILE) then
        local ok, data = pcall(readfile, SETTINGS_FILE)
        if ok and data and data ~= "" then
            local success, decoded = pcall(HttpService.JSONDecode, HttpService, data)
            if success and type(decoded) == "table" then
                return decoded
            end
        end
    end
    return {
        infJumpEnabled = false,
        espEnabled = false,
        baseESPEnabled = false,
        timerESPEnabled = false
    }
end

-- Guardar configuraci贸n
local function saveSettings(tbl)
    if writefile then
        local encoded = HttpService:JSONEncode(tbl)
        writefile(SETTINGS_FILE, encoded)
    end
end

-- Cargar o crear configuraci贸n
getgenv().FreeUGS_Settings = loadSettings()

-------------------------------------------------
--  INTERFAZ (GUI)
-------------------------------------------------
local gui = Instance.new("ScreenGui")
gui.Name = "FreeUGSGUI"
gui.ResetOnSpawn = false
gui.Parent = game.Players.LocalPlayer:WaitForChild("PlayerGui")

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 200, 0, 200)
frame.Position = UDim2.new(0, 20, 0.5, -85)
frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
frame.BackgroundTransparency = 0.2
frame.Active = true
frame.Draggable = true
frame.Parent = gui

local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 12)
corner.Parent = frame

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, 30)
title.BackgroundTransparency = 1
title.Text = " FreeUGS GUI"
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.Font = Enum.Font.GothamBold
title.TextSize = 18
title.Parent = frame

local function createButton(text, yPos)
    local button = Instance.new("TextButton")
    button.Size = UDim2.new(0.9, 0, 0, 30)
    button.Position = UDim2.new(0.05, 0, 0, yPos)
    button.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    button.Text = text
    button.TextColor3 = Color3.fromRGB(255, 255, 255)
    button.Font = Enum.Font.Gotham
    button.TextSize = 14
    button.Parent = frame

    local bc = Instance.new("UICorner")
    bc.CornerRadius = UDim.new(0, 8)
    bc.Parent = button

    return button
end

-- Botones
local infJumpBtn = createButton("Infinite Jump", 40)
local espBtn = createButton("Player ESP", 80)
local baseESPBtn = createButton("BASE ESP", 120)
local timerESPBtn = createButton("Timer ESP", 160)

-------------------------------------------------
--  INFINITE JUMP
-------------------------------------------------
local UserInputService = game:GetService("UserInputService")

infJumpBtn.MouseButton1Click:Connect(function()
    getgenv().FreeUGS_Settings.infJumpEnabled = not getgenv().FreeUGS_Settings.infJumpEnabled
    infJumpBtn.Text = getgenv().FreeUGS_Settings.infJumpEnabled and "Infinite Jump: ON" or "Infinite Jump: OFF"
    saveSettings(getgenv().FreeUGS_Settings)
end)

if getgenv().FreeUGS_Settings.infJumpEnabled then
    infJumpBtn.Text = "Infinite Jump: ON"
end

UserInputService.JumpRequest:Connect(function()
    if not getgenv().FreeUGS_Settings.infJumpEnabled then return end

    local player = game.Players.LocalPlayer
    local char = player.Character
    if char and char:FindFirstChild("HumanoidRootPart") and char:FindFirstChildOfClass("Humanoid") then
        local hrp = char.HumanoidRootPart
        local humanoid = char:FindFirstChildOfClass("Humanoid")
        hrp.Velocity = Vector3.new(hrp.Velocity.X, humanoid.JumpPower, hrp.Velocity.Z)
    end
end)

-------------------------------------------------
--  PLAYER ESP
-------------------------------------------------
local espFolder = Instance.new("Folder", gui)
espFolder.Name = "ESP_Objects"

local function createESP(player)
    if player == game.Players.LocalPlayer then return end
    if not player.Character then player.CharacterAdded:Wait() end
    local char = player.Character
    if not char:FindFirstChild("HumanoidRootPart") then return end

    local highlight = Instance.new("Highlight")
    highlight.Adornee = char
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    highlight.FillColor = Color3.fromRGB(255, 100, 100)
    highlight.FillTransparency = 0.75
    highlight.OutlineColor = Color3.fromRGB(255, 0, 0)
    highlight.Parent = espFolder

    local billboard = Instance.new("BillboardGui")
    billboard.Name = "NameTag"
    billboard.Adornee = char:WaitForChild("Head")
    billboard.Size = UDim2.new(0, 100, 0, 25)
    billboard.StudsOffset = Vector3.new(0, 2.5, 0)
    billboard.AlwaysOnTop = true
    billboard.Parent = espFolder

    local nameLabel = Instance.new("TextLabel")
    nameLabel.Size = UDim2.new(1, 0, 1, 0)
    nameLabel.BackgroundTransparency = 1
    nameLabel.Text = player.DisplayName
    nameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    nameLabel.TextStrokeTransparency = 0.5
    nameLabel.Font = Enum.Font.GothamBold
    nameLabel.TextScaled = true
    nameLabel.Parent = billboard

    player.CharacterAdded:Connect(function(newChar)
        task.wait(1)
        highlight.Adornee = newChar
        if newChar:FindFirstChild("Head") then
            billboard.Adornee = newChar.Head
        end
    end)
end

local function refreshESP()
    espFolder:ClearAllChildren()
    if getgenv().FreeUGS_Settings.espEnabled then
        for _, p in ipairs(game.Players:GetPlayers()) do
            createESP(p)
        end
    end
end

espBtn.MouseButton1Click:Connect(function()
    getgenv().FreeUGS_Settings.espEnabled = not getgenv().FreeUGS_Settings.espEnabled
    espBtn.Text = getgenv().FreeUGS_Settings.espEnabled and "Player ESP: ON" or "Player ESP: OFF"
    refreshESP()
    saveSettings(getgenv().FreeUGS_Settings)
end)

if getgenv().FreeUGS_Settings.espEnabled then
    espBtn.Text = "Player ESP: ON"
    refreshESP()
end

game.Players.PlayerAdded:Connect(function(p)
    if getgenv().FreeUGS_Settings.espEnabled then
        task.wait(2)
        createESP(p)
    end
end)

-------------------------------------------------
--  BASE ESP
-------------------------------------------------
local originalTransparencies = {}

local function toggleBaseESP(enable)
    local plotsFolder = game.Workspace:FindFirstChild("Plots")
    if not plotsFolder then return end

    for _, model in ipairs(plotsFolder:GetChildren()) do
        if model:IsA("Model") then
            local decorationsFolder = model:FindFirstChild("Decorations")
            if decorationsFolder then
                for _, obj in ipairs(decorationsFolder:GetDescendants()) do
                    if obj:IsA("BasePart") then
                        if enable then
                            if not originalTransparencies[obj] then
                                originalTransparencies[obj] = obj.Transparency
                            end
                            obj.Transparency = 0.7
                        else
                            if originalTransparencies[obj] then
                                obj.Transparency = originalTransparencies[obj]
                            end
                        end
                    end
                end
            end
        end
    end
end

baseESPBtn.MouseButton1Click:Connect(function()
    getgenv().FreeUGS_Settings.baseESPEnabled = not getgenv().FreeUGS_Settings.baseESPEnabled
    baseESPBtn.Text = getgenv().FreeUGS_Settings.baseESPEnabled and "BASE ESP: ON" or "BASE ESP: OFF"
    toggleBaseESP(getgenv().FreeUGS_Settings.baseESPEnabled)
    saveSettings(getgenv().FreeUGS_Settings)
end)

if getgenv().FreeUGS_Settings.baseESPEnabled then
    baseESPBtn.Text = "BASE ESP: ON"
    toggleBaseESP(true)
end

-------------------------------------------------
--  TIMER ESP
-------------------------------------------------
local originalSizes, originalTextSizes, originalVisibility, originalBillboardVisibility, originalAlwaysOnTop, originalMaxDistance = {}, {}, {}, {}, {}, {}

local function ajustarTimerESP(enable)
    local plotsFolder = workspace:FindFirstChild("Plots")
    if not plotsFolder then return end

    for _, plot in ipairs(plotsFolder:GetChildren()) do
        local purchases = plot:FindFirstChild("Purchases")
        if purchases then
            local plotBlock = purchases:FindFirstChild("PlotBlock")
            if plotBlock then
                local main = plotBlock:FindFirstChild("Main")
                if main then
                    local billboardGui = main:FindFirstChild("BillboardGui")
                    if billboardGui then
                        if enable then
                            if not originalSizes[billboardGui] then
                                originalSizes[billboardGui] = billboardGui.Size
                                originalAlwaysOnTop[billboardGui] = billboardGui.AlwaysOnTop
                                originalMaxDistance[billboardGui] = billboardGui.MaxDistance
                                originalBillboardVisibility[billboardGui] = billboardGui.Enabled or true
                            end
                            billboardGui.AlwaysOnTop = true
                            billboardGui.MaxDistance = math.huge
                            billboardGui.Size = UDim2.new(0, 300, 0, 150)
                            billboardGui.Enabled = true
                        else
                            if originalSizes[billboardGui] then
                                billboardGui.Size = originalSizes[billboardGui]
                                billboardGui.AlwaysOnTop = originalAlwaysOnTop[billboardGui]
                                billboardGui.MaxDistance = originalMaxDistance[billboardGui]
                                billboardGui.Enabled = originalBillboardVisibility[billboardGui]
                            else
                                billboardGui.Enabled = false
                            end
                        end

                        local elementosNombres = {"Delay", "LockStudio", "Locked", "RemainingTime"}
                        for _, nombre in ipairs(elementosNombres) do
                            local texto = billboardGui:FindFirstChild(nombre)
                            if texto and texto:IsA("TextLabel") then
                                if enable then
                                    if not originalTextSizes[texto] then
                                        originalTextSizes[texto] = texto.TextSize
                                    end
                                    if originalVisibility[texto] == nil then
                                        originalVisibility[texto] = texto.Visible
                                    end
                                    texto.Visible = true
                                    texto.TextSize = 48
                                    texto.TextWrapped = true
                                else
                                    if originalTextSizes[texto] then
                                        texto.TextSize = originalTextSizes[texto]
                                    end
                                    if originalVisibility[texto] ~= nil then
                                        texto.Visible = originalVisibility[texto]
                                    else
                                        texto.Visible = false
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end
    end
end

timerESPBtn.MouseButton1Click:Connect(function()
    getgenv().FreeUGS_Settings.timerESPEnabled = not getgenv().FreeUGS_Settings.timerESPEnabled
    timerESPBtn.Text = getgenv().FreeUGS_Settings.timerESPEnabled and "Timer ESP: ON" or "Timer ESP: OFF"
    ajustarTimerESP(getgenv().FreeUGS_Settings.timerESPEnabled)
    saveSettings(getgenv().FreeUGS_Settings)
end)

if getgenv().FreeUGS_Settings.timerESPEnabled then
    timerESPBtn.Text = "Timer ESP: ON"
    ajustarTimerESP(true)
end


-------------------------------------------------
--  ANTI-RAGDOLL
-------------------------------------------------
-- Crear bot贸n
local antiRagdollBtn = createButton("Anti-Ragdoll", 200)

-- Funci贸n para activar/desactivar anti-ragdoll
local function toggleAntiRagdoll(enable)
    local player = game.Players.LocalPlayer
    local character = player.Character or player.CharacterAdded:Wait()
    local humanoid = character:WaitForChild("Humanoid")
    local rootPart = character:WaitForChild("HumanoidRootPart")

    -- Desconectar conexiones previas si existen
    if getgenv().AntiRagdollConnections then
        for _, conn in ipairs(getgenv().AntiRagdollConnections) do
            conn:Disconnect()
        end
    end
    getgenv().AntiRagdollConnections = {}

    if enable then
        -- Evitar estado Physics (ragdoll)
        table.insert(getgenv().AntiRagdollConnections, humanoid.StateChanged:Connect(function(_, newState)
            if newState == Enum.HumanoidStateType.Physics then
                humanoid:ChangeState(Enum.HumanoidStateType.GettingUp)
            end
        end))

        -- Mantener posici贸n estable
        table.insert(getgenv().AntiRagdollConnections, game:GetService("RunService").RenderStepped:Connect(function()
            if humanoid:GetState() == Enum.HumanoidStateType.Physics then
                rootPart.Velocity = Vector3.zero
                rootPart.RotVelocity = Vector3.zero
            end
        end))
    end
end

-- Toggle desde el bot贸n
antiRagdollBtn.MouseButton1Click:Connect(function()
    getgenv().FreeUGS_Settings.antiRagdollEnabled = not getgenv().FreeUGS_Settings.antiRagdollEnabled
    antiRagdollBtn.Text = getgenv().FreeUGS_Settings.antiRagdollEnabled and "Anti-Ragdoll: ON" or "Anti-Ragdoll: OFF"
    toggleAntiRagdoll(getgenv().FreeUGS_Settings.antiRagdollEnabled)
    saveSettings(getgenv().FreeUGS_Settings)
end)

-- Activar al iniciar si estaba guardado
if getgenv().FreeUGS_Settings.antiRagdollEnabled then
    antiRagdollBtn.Text = "Anti-Ragdoll: ON"
    toggleAntiRagdoll(true)
end
